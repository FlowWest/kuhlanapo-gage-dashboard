name: USGS Lake Level Refresh

on:
  schedule:
    # 7:XXam Pacific = 14:XX UTC (standard), 15:XX UTC (DST)
    # Run twice; script enforces PT time window
    - cron: "15 14 * * *"
    - cron: "15 15 * * *"
  workflow_dispatch:

concurrency:
  group: data-pull-lock
  cancel-in-progress: false
  
jobs:
  refresh:
    runs-on: ubuntu-latest

    steps:
      - name: Check schedule against time zone
        id: ptcheck
        if: github.event_name == 'schedule'
        run: |
          PT_HOUR=$(TZ=America/Los_Angeles date +'%H')

          if [ "$PT_HOUR" = "07" ]; then
            echo "run_job=true" >> $GITHUB_OUTPUT
          else
            echo "run_job=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not correct scheduled time
        if: github.event_name == 'schedule' && steps.ptcheck.outputs.run_job != 'true'
        run: |
          echo "Not at the schedule time in PT. Skipping scheduled run."
          exit 0
          
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system deps
        run: sudo apt-get install -y libcurl4-openssl-dev

      - name: Install R packages
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            httr
            dplyr
            lubridate
            stringr
            terra

      - name: Install inldata from USGS
        run: |
          Rscript -e 'install.packages("remotes")'
          Rscript -e 'remotes::install_git("https://code.usgs.gov/inl/inldata.git", upgrade = "never")'

      - name: Fetch USGS lake level data
        run: |
          Rscript scripts/fetch_usgs_lake_level.R

      - name: Commit updated data
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/usgs_lake_level_11450000.rds
          git commit -m "Daily USGS lake level refresh" || echo "No changes"
          git push
