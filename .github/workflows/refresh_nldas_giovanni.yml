name: Refresh NLDAS Giovanni Time Series

on:
#  schedule:
#    # 7:XXam Pacific = 14:XX UTC (standard), 15:XX UTC (DST)
#    # Run twice; script enforces PT time window
#    - cron: "20 14 * * *"
#    - cron: "20 15 * * *"
  workflow_dispatch:

concurrency:
  group: data-pull-lock
  cancel-in-progress: false
  
jobs:
  fetch_nldas:
    runs-on: ubuntu-latest
    environment: earthdata

    steps:
      - name: Check schedule against time zone
        id: ptcheck
        if: github.event_name == 'schedule'
        run: |
          PT_HOUR=$(TZ=America/Los_Angeles date +'%H')

          if [ "$PT_HOUR" = "07" ]; then
            echo "run_job=true" >> $GITHUB_OUTPUT
          else
            echo "run_job=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not correct scheduled time
        if: github.event_name == 'schedule' && steps.ptcheck.outputs.run_job != 'true'
        run: |
          echo "Not at the schedule time in PT. Skipping scheduled run."
          exit 0
          
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          packages: |
            httr2
            readr
            dplyr
            lubridate
            tibble

      - name: Fetch NLDAS Giovanni Data
        env:
          EARTHDATA_TOKEN: ${{ secrets.EARTHDATA_TOKEN }}
        run: |
          Rscript scripts/fetch_nldas_giovanni.R

      - name: Commit updated data
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/precip_ts.rds
          git commit -m "Daily precip refresh" || echo "No changes"
          git push
